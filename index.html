<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loaf Points</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.18/dist/full.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" type="image/png" href="assets/favicon.png">

  <style>
    #fxLayer { position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 9999; }
    .crumb {
      position: absolute;
      will-change: transform, opacity;
      font-size: 28px;
      opacity: 0.95;
      transform: translate(-50%, -50%);
      animation: fly 700ms ease-out forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
    }
    @keyframes fly {
      to {
        transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) rotate(var(--rot));
        opacity: 0;
      }
    }
  </style>
</head>

<body class="bg-base-300 min-h-screen text-base-content">
<div id="fxLayer"></div>

<div class="max-w-7xl mx-auto p-6 space-y-4">

  <!-- LOGO -->
  <div class="flex flex-col items-center text-center mb-4">
    <img src="assets/logo.png" class="h-56 w-auto object-contain mb-3" alt="Logo" />
    <h1 class="text-4xl font-extrabold">üçû Loaf Points</h1>
    <div class="opacity-70 mt-1">
      Compete to Get Ranked ‚Ä¢ Redeem Loafs on Twitch ‚Ä¢ Track your Loaf Points Here
    </div>
    <div id="status" class="text-sm opacity-70 mt-1"></div>
  </div>

  <!-- CONTROLS -->
  <div class="flex justify-end mb-2">
    <div class="flex items-center gap-2">
      <select id="boardSelect" class="select select-bordered"></select>
      <button id="authBtn" class="btn btn-primary">
        <i class="fa-brands fa-twitch"></i>
        <span id="authBtnText">Login</span>
      </button>
    </div>
  </div>

  <!-- GRID -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-start">

    <!-- LEFT -->
    <div class="lg:col-span-3 lg:sticky lg:top-4 space-y-4">
      <div class="min-h-[260px]">

        <div id="acctLoading" class="card bg-base-200 shadow hidden">
          <div class="card-body">
            <div class="text-lg font-bold">Loading Account Info‚Ä¶</div>
            <div class="text-sm opacity-70">Checking Twitch login.</div>
            <div class="mt-3 flex items-center gap-3 opacity-70">
              <span class="loading loading-spinner loading-md"></span>
              <span>Please wait‚Ä¶</span>
            </div>
          </div>
        </div>

        <div id="meCard" class="card bg-base-200 shadow hidden">
          <div class="card-body">
            <div class="text-sm opacity-70">Logged in as</div>
            <div id="meName" class="text-xl font-bold"></div>

            <div class="mt-3 grid gap-3">
              <div class="bg-base-300 rounded-xl p-3">
                <div class="text-sm opacity-70">Loaf Points (current)</div>
                <div id="meTotalPoints" class="text-3xl font-extrabold">0</div>
              </div>

              <div class="bg-base-300 rounded-xl p-3">
                <div class="text-sm opacity-70">Board rank</div>
                <div id="meRank" class="text-3xl font-extrabold">‚Äî</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="loginHint" class="card bg-base-200 shadow">
        <div class="card-body">
          <div class="text-lg font-bold">How it works</div>
          <div class="text-sm opacity-70">
            Login with Twitch to view Loaf Points and rankings.
          </div>
        </div>
      </div>
    </div>

    <!-- CENTER -->
    <div class="lg:col-span-6 space-y-4">

      <!-- LEADERBOARD -->
      <div class="card bg-base-200 shadow">
        <div class="card-body">
          <div class="flex justify-between">
            <div class="text-xl font-bold">Leaderboard</div>
            <div id="updated" class="text-sm opacity-70"></div>
          </div>
          <div id="lb" class="mt-3 space-y-2"></div>

          <div class="mt-4 flex justify-between">
            <button id="lbPrev" class="btn btn-sm btn-outline" disabled><i class="fa-solid fa-chevron-left"></i></button>
            <div id="lbPageInfo" class="text-sm opacity-70">Page 1</div>
            <button id="lbNext" class="btn btn-sm btn-outline" disabled><i class="fa-solid fa-chevron-right"></i></button>
          </div>
        </div>
      </div>

      <!-- POLL -->
      <div class="card bg-base-200 shadow">
        <div class="card-body">

          <div class="flex justify-between items-center">
            <div id="pollStateBadge" class="badge badge-outline font-bold">CLOSED</div>
            <button id="pollRefreshBtn" class="btn btn-sm btn-outline">Refresh</button>
          </div>

          <div class="mt-2">
            <div id="pollTitle" class="text-2xl font-extrabold"></div>
            <div id="pollSubtitle" class="text-sm opacity-70"></div>
          </div>

          <div id="pollMsg" class="text-sm mt-2"></div>

          <div class="mt-4">
            <div class="text-sm opacity-70 mb-2">Current Top Bans</div>
            <div id="pollTop" class="flex flex-wrap gap-2"></div>
          </div>

          <div class="mt-4">
            <div id="pollTotals" class="space-y-2"></div>

            <div class="mt-4 flex justify-between">
              <button id="pollPrev" class="btn btn-sm btn-outline" disabled><i class="fa-solid fa-chevron-left"></i></button>
              <div id="pollPageInfo" class="text-sm opacity-70">Page 1</div>
              <button id="pollNext" class="btn btn-sm btn-outline" disabled><i class="fa-solid fa-chevron-right"></i></button>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="lg:col-span-3 lg:sticky lg:top-4 space-y-4">
      <div class="card bg-base-200 shadow">
        <div class="card-body">
          <div class="text-lg font-bold">Tip</div>
          <div class="text-sm opacity-70">
            Use the dropdown to switch leaderboards.
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "https://script.google.com/macros/s/AKfycbwg_pn2J8399br-rnzHT36BG2JtIgB1nPEfya9PTV9TD__kwidzJUZZqRfb-o7I5baHkA/exec";
const TWITCH_CLIENT_ID = "h450xh8v0w6osff946wcqnb8vr2st4";
const TOURNAMENT_ID = "DGIL_NEXT";

/* BOARDS */
const BOARDS = [
  { id: "general", label: "Leaderboard (General)" },
  { id: "rivals2", label: "Rivals of Aether 2" },
  { id: "rivals1", label: "Rivals of Aether" },
  { id: "nasb2", label: "Nickelodeon All-Star Brawl 2" }
];

const PAGE_SIZE = 12;
const POLL_PAGE_SIZE = 5;

let currentBoard = localStorage.getItem("loaf_board") || "general";
let lbPage = 1;
let pollPage = 1;
let pollCache = null;
let pollExpandedId = null;
let voteBusy = false;

/* ================= HELPERS ================= */
const $ = id => document.getElementById(id);
const getToken = () => sessionStorage.getItem("twitch_token");

function topIcon(rank){
  if (rank===1) return '<i class="fa-solid fa-crown text-yellow-400"></i>';
  if (rank===2) return '<i class="fa-solid fa-medal text-gray-300"></i>';
  if (rank===3) return '<i class="fa-solid fa-medal text-orange-400"></i>';
  return '<i class="fa-solid fa-user opacity-60"></i>';
}

/* ================= FX ================= */
function throwLoafs(){
  const layer = $("fxLayer");
  if (!layer) return;
  for (let i=0;i<14;i++){
    const el=document.createElement("div");
    el.className="crumb";
    el.textContent="üçû";
    el.style.left="50%";
    el.style.top="35%";
    el.style.setProperty("--dx",(Math.random()*260-130)+"px");
    el.style.setProperty("--dy",(Math.random()*220-220)+"px");
    el.style.setProperty("--rot",(Math.random()*240-120)+"deg");
    layer.appendChild(el);
    setTimeout(()=>el.remove(),750);
  }
}
</script>
</body>
</html>
