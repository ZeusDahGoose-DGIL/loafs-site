<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loaf Points</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.18/dist/full.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" type="image/png" href="assets/favicon.png">

  <!-- Pixel font for Prize Pool amount ONLY -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    /* Fallback: if Tailwind glitches, hidden still hides (prevents overlays blocking clicks) */
    .hidden { display: none !important; }

    /* FX layer for loaf toss */
    #fxLayer { position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 9999; }
    .crumb {
      position: absolute;
      will-change: transform, opacity;
      font-size: 28px;
      opacity: 0.95;
      transform: translate(-50%, -50%);
      animation: fly 700ms ease-out forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
    }
    @keyframes fly {
      to { transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) rotate(var(--rot)); opacity: 0; }
    }
    .charRow:hover { outline: 2px solid rgba(255,255,255,.07); }

    /* Overlay loader (darken + centered text) */
    .overlayBox {
      position: absolute;
      inset: 0;
      border-radius: 1rem;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(1px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    /* Tabs mobile scroll */
    .tabsScroll {
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .tabsScroll::-webkit-scrollbar { display: none; }

    /* Guardrail to prevent sideways page scroll */
    html, body { overflow-x: hidden; }

    /* Prize Pool amount: pixel font ONLY here */
    .prizePoolAmount {
      font-family: "Press Start 2P", system-ui, sans-serif;
      letter-spacing: 0.02em;
      line-height: 1.15;
      text-shadow: 0 2px 0 rgba(0,0,0,.35);
    }
/* ===== Top 3 glow ===== */
.lbTop1 {
  box-shadow:
    0 0 0 1px rgba(255,255,255,.08),
    0 0 18px rgba(255,215,0,.20);
}

.lbTop2 {
  box-shadow:
    0 0 0 1px rgba(255,255,255,.08),
    0 0 18px rgba(192,192,192,.18);
}

.lbTop3rd {
  box-shadow:
    0 0 0 1px rgba(255,255,255,.08),
    0 0 18px rgba(205,127,50,.18);
}
    /* ===== Desktop/default: single-line leaderboard row ===== */
.lbRow {
  align-items: center;
}

.lbLeft {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  width: 100%;
  min-width: 0;
}

.lbNameRow {
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 0;
}

.lbName {
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.lbPoints {
  margin-left: auto;
  margin-top: 0;
  align-self: center;
  flex: 0 0 auto;
}
/* ===== Mobile: stack leaderboard row (points under name) ===== */
@media (max-width: 640px) {
  .lbRow {
    align-items: flex-start !important;
    gap: 10px;
  }

  .lbLeft {
    display: flex;
    flex-direction: column;   /* üî• force vertical stacking again */
    min-width: 0;
    width: 100%;
  }

  .lbNameRow {
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 0;
  }

  .lbName {
    white-space: normal;      /* üî• allow wrapping on mobile */
    overflow: visible;        /* üî• no ellipsis */
    text-overflow: unset;
    line-height: 1.25;
  }

  .lbPoints {
    margin-left: 44px;        /* keeps it lined under name */
    margin-top: 6px;
    align-self: flex-start;
  }

  /* Slightly smaller pill on mobile so it feels cleaner */
  .lbPoints .badge {
    font-size: 1rem;
    padding-left: 14px;
    padding-right: 14px;
  }
}
/* Current Tournament active glow (clean, no spin) */
.ctActive{
  position: relative;
  box-shadow:
    0 0 0 1px rgba(255,255,255,.10),
    0 0 14px rgba(255,255,255,.10);
  animation: ctPulse 2.6s ease-in-out infinite;
}

@keyframes ctPulse{
  0%, 100%{
    box-shadow:
      0 0 0 1px rgba(255,255,255,.10),
      0 0 14px rgba(255,255,255,.10);
  }
  50%{
    box-shadow:
      0 0 0 1px rgba(255,255,255,.14),
      0 0 22px rgba(255,255,255,.18);
  }
}
    /* Prevent layout shift when vertical scrollbar appears/disappears */
html { scrollbar-gutter: stable; }

/* Fallback for older browsers: always reserve scrollbar space */
@supports not (scrollbar-gutter: stable) {
  html { overflow-y: scroll; }
}
    .lbNoResults {
  text-align: center;
  padding: 28px 16px;
  border-radius: 1rem;
  background: rgba(255,255,255,.03);
}
.lbNoResults .title {
  font-size: 1.35rem;
  font-weight: 800;
  line-height: 1.15;
}
.lbNoResults .sub {
  margin-top: 6px;
  opacity: .7;
  font-size: .95rem;
}
    /* ===== Leaderboard Avatars ===== */
.lbAvatar {
  width: 50px;
  height: 50px;
  border-radius: 9999px;
  overflow: hidden;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  flex: 0 0 auto;
  box-shadow: 0 0 0 1px rgba(255,255,255,.12);
}

.lbAvatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.lbAvatar i {
  font-size: 14px;
  opacity: .7;
}
    /* ===== Fix long usernames overflowing leaderboard rows ===== */
.lbName {
  overflow-wrap: anywhere;
  word-break: break-word;
}

/* Flexbox safety so rows can shrink properly */
.lbNameRow { min-width: 0; }
.lbLeft { min-width: 0; }

    /* ===== Shop UI ===== */
.shopGrid {
  display: grid;
  grid-template-columns: repeat(1, minmax(0, 1fr));
  gap: 12px;
}

@media (min-width: 768px) {
  .shopGrid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

.shopItem {
  background: rgba(255,255,255,.03);
  border-radius: 1rem;
  padding: 14px;
  box-shadow: 0 0 0 1px rgba(255,255,255,.08);
}

.shopPrice {
  font-weight: 800;
}

    /* ===== Shop lists scroll safely (GREEN) ===== */
.shopList{
  max-height: 56vh;          /* keeps it inside modal */
  overflow-y: auto;
  padding-right: 6px;        /* room for scrollbar */
}

/* optional: nicer scrollbar */
.shopList::-webkit-scrollbar { width: 10px; }
.shopList::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,.10);
  border-radius: 999px;
}

/* ===== Shop Tabs: always bordered ===== */
.shopTabBtn{
  width: 100%;
  justify-content: flex-start;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.03);
}

.shopTabBtn:hover{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.18);
}

.shopTabBtn.shopTabActive{
  border-color: rgba(255,255,255,.28);
  background: rgba(99,102,241,.20); /* soft indigo-ish, matches your vibe */
  box-shadow: 0 0 0 1px rgba(99,102,241,.15);
}

    /* ===== Shop falling loaf FX (right pane only) ===== */
#shopRedeemsPane{
  position: relative;
  overflow: hidden;
}

#shopRedeemsFx{
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 0;
  overflow: hidden;          /* extra safety */
}

/* content above the FX */
#shopRedeemsContent{
  position: relative;
  z-index: 1;
}

/* individual loaf */
.shopLoaf{
  position: absolute;
  top: -60px;
  left: 50%;
  opacity: .12;              /* transparent */
  font-size: 30px;           /* tweak size here */
  transform: translateX(-50%);
  will-change: transform, top, opacity;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
  animation-name: shopLoafFall;
  animation-timing-function: linear;
  animation-iteration-count: 1;
  z-index: 0;                /* behind */
}

@keyframes shopLoafFall{
  0%{
    transform: translateX(-50%) rotate(0deg);
    top: -60px;
    opacity: 0;
  }
  10%{ opacity: .12; }
  100%{
    transform: translateX(calc(-50% + var(--drift))) rotate(var(--spin));
    top: 115%;
    opacity: 0;
  }
}

    .pixelNum{
  font-family: "Press Start 2P", system-ui, sans-serif;
  letter-spacing: 0.02em;
}

    /* Prize Pool loader: big + centered + matches the amount area */
.prizePoolLoading {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  min-height: 72px; /* keeps it from feeling tiny */
}

/* Prevent prize pool box from resizing while loading */
#prizePoolAmount {
  min-height: 4.5rem;          /* matches your big number height */
  display: flex;
  align-items: center;
  justify-content: center;
}
  </style>
</head>

<body class="bg-base-300 min-h-screen text-base-content">
  <div id="fxLayer"></div>

  <div class="max-w-7xl mx-auto p-6 space-y-4">

    <!-- LOGO + TITLE -->
    <div class="flex flex-col items-center text-center mb-2">
      <img src="assets/logo.png" class="h-56 w-auto object-contain mb-3" alt="Logo" />
      <h1 class="text-4xl font-extrabold flex items-center gap-2">üçû Loaf Points</h1>
      <div class="opacity-70 mt-1">
        Compete to Get Ranked ‚Ä¢ Redeem Loafs on Twitch ‚Ä¢ Track your Loaf Points Here
      </div>
      <div id="status" class="text-sm opacity-70 mt-1"></div>
    </div>

    <!-- TABS (under header, scrollable on mobile) -->
    <div class="tabsScroll">
      <div class="tabs tabs-boxed min-w-max">
        <a id="tab_overview" class="tab tab-active">Overview</a>
        <a id="tab_leaderboards" class="tab">Leaderboards</a>
        <a id="tab_prizepool" class="tab">DGIL Prize Pool</a>
        <a id="tab_voting" class="tab">Voting / Redeems</a>
        <a id="tab_howtoloaf" class="tab">How to Loaf</a>
      </div>
    </div>

<!-- TOP CONTROLS (always visible) -->
<div class="flex justify-between items-center -mt-2 gap-2">
  <!-- LEFT: Current Tournament button -->
<button id="ctBtn" class="btn btn-outline btn-sm">
  <i class="fa-solid fa-trophy"></i>
  <span>Current Tournament</span>
</button>


  <!-- RIGHT: board dropdown + login -->
  <div class="flex items-center gap-2">
    <select id="boardSelect" class="select select-bordered hidden"></select>

    <button id="authBtn" class="btn btn-primary">
      <i class="fa-brands fa-twitch"></i>
      <span id="authBtnText">Login</span>
    </button>
  </div>
</div>

    <!-- PANELS -->
    <div class="space-y-4">

<!-- OVERVIEW -->
<section id="panel_overview" class="space-y-4">

  <!-- Main intro -->
  <div class="card bg-base-200 shadow">
    <div class="card-body space-y-2">
      <div class="text-3xl font-extrabold">Dah Goose Is Loose (DGIL)</div>
      <div class="opacity-70">
        DGIL is an online tournament series I run <span class="font-bold">1‚Äì2 times per month</span>, with
        <span class="font-bold">Rivals of Aether 2</span> as the main focus.
      </div>
      <div class="opacity-70">
        Alongside standard events, I‚Äôll also host fun and experimental tournaments ‚Äî like gimmicky Rivals 2 formats,
        Rivals 1, Workshop events (R1 &amp; R2), NASB2, and more as time goes on.
      </div>
    </div>
  </div>

  <!-- Regions -->
  <div class="card bg-base-200 shadow">
    <div class="card-body space-y-2">
      <div class="text-2xl font-extrabold">üåé Regions</div>
      <div class="opacity-70">
        DGIL tournaments are currently <span class="font-bold">region locked to North America</span>.
      </div>
      <div class="opacity-70">
        From time to time, I will run polls in my Discord server where the community can vote on whether a specific
        tournament should be opened to more regions or globally.
      </div>
      <div class="opacity-70">
        Separately from polls, I may also choose to host <span class="font-bold">EU-only tournaments</span> in the future.
      </div>
    </div>
  </div>

  <!-- Prize Pool -->
  <div class="card bg-base-200 shadow">
    <div class="card-body space-y-3">
      <div class="text-2xl font-extrabold">üí∞ Prize Pool</div>
      <div class="opacity-70">
        Every DGIL tournament starts with a <span class="font-bold">guaranteed $100 prize pool</span> ‚Äî I put this in myself so there is
        always a payout.
      </div>
      <div class="opacity-70">
        If the prize pool reaches <span class="font-bold">$200 or more</span>, the payout structure upgrades from
        <span class="font-bold">Top 3</span> to <span class="font-bold">Top 8</span>.
      </div>

      <div class="flex flex-wrap gap-2">
        <a class="btn btn-success btn-sm" href="https://streamlabs.com/zeusdahgoose/tip" target="_blank" rel="noopener">
          üí∏ Donate to the Prize Pool
        </a>
      </div>

<div class="text-base font-bold opacity-90">
  (Please include ‚ÄúDGIL‚Äù in the message so I know it‚Äôs for the tournament.)
</div>
    </div>
  </div>

  <!-- Where to Watch -->
  <div class="card bg-base-200 shadow">
    <div class="card-body space-y-3">
      <div class="text-2xl font-extrabold">üì∫ Where to Watch</div>
      <div class="opacity-70">
        All Dah Goose Is Loose tournaments are streamed live with lovely casters, and are multistreamed to Twitch &amp; YouTube.
      </div>
      <div class="opacity-70">
        Entrants are always welcome to stream their own runs during the tournament, so feel free to share your POV and support fellow players.
      </div>

      <div class="flex flex-wrap gap-2">
        <a class="btn btn-primary btn-sm" href="https://www.twitch.tv/zeusdahgoose" target="_blank" rel="noopener">
          <i class="fa-brands fa-twitch"></i>
          Watch on Twitch
        </a>

        <a class="btn btn-error btn-sm" href="https://www.youtube.com/@ZeusDahGoose" target="_blank" rel="noopener">
          <i class="fa-brands fa-youtube"></i>
          Watch on YouTube
        </a>
      </div>
    </div>
  </div>

  <!-- Join the Community -->
  <div class="card bg-base-200 shadow">
    <div class="card-body space-y-3">
      <div class="text-2xl font-extrabold">üí¨ Join the Community</div>
      <div class="opacity-70">
        Join the DGIL Discord to stay up to date on upcoming tournaments, region voting polls, announcements, and general community silliness.
      </div>

      <div class="flex flex-wrap gap-2">
        <a class="btn btn-secondary btn-sm" href="https://discord.gg/YVKxHMJY3P" target="_blank" rel="noopener">
          <i class="fa-brands fa-discord"></i>
          Join the Discord
        </a>
      </div>
    </div>
  </div>

</section>

      <!-- LEADERBOARDS -->
      <section id="panel_leaderboards" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-start">

          <!-- LEFT -->
          <div class="lg:col-span-3 lg:sticky lg:top-4 space-y-4">

            <!-- IMPORTANT: removed the empty min-h spacer so "How it works" lines up with the leaderboard when logged out -->
<div>
  <!-- Shown only during FIRST login load (not on auto-refresh) -->
  <div id="acctLoading" class="card bg-base-200 shadow hidden min-h-[260px]">
    <div class="card-body">
      <div class="text-lg font-bold">Loading Account Info‚Ä¶</div>
      <div class="text-sm opacity-70">
        Checking your Twitch login and pulling your Loaf Points.
      </div>
      <div class="mt-3 flex items-center gap-3 opacity-70">
        <span class="loading loading-spinner loading-md"></span>
        <span class="text-sm">Please wait‚Ä¶</span>
      </div>
    </div>
  </div>

  <!-- Normal account card -->
  <div id="meCard" class="card bg-base-200 shadow hidden min-h-[260px]">
    <div class="card-body relative">
      <div class="text-sm opacity-70">Logged in as</div>
      <div id="meName" class="text-xl font-bold"></div>

      <div class="mt-3 grid grid-cols-1 gap-3">
        <div class="bg-base-300 rounded-xl p-3">
          <div class="text-sm opacity-70">Loaf Points (current)</div>
          <div id="meTotalPoints" class="text-3xl font-extrabold">0</div>
        </div>

        <div class="bg-base-300 rounded-xl p-3">
          <div class="text-sm opacity-70">Board rank</div>
          <div id="meRank" class="text-3xl font-extrabold">‚Äî</div>
        </div>
      </div>

      <!-- NEW: overlay for auto-refresh -->
      <div id="meOverlay" class="overlayBox hidden">
        <div class="flex items-center gap-3 bg-base-300 rounded-xl px-4 py-3 shadow">
          <span class="loading loading-spinner loading-md"></span>
          <div class="text-lg font-bold" id="meOverlayText">Refreshing‚Ä¶</div>
        </div>
      </div>

    </div>
  </div>
</div>

            <div id="loginHint" class="card bg-base-200 shadow">
              <div class="card-body">
                <div class="text-lg font-bold">How it works</div>
                <div class="text-sm opacity-70">
                  Login with Twitch to view your Loaf Points, see your rank on the leaderboard, and rankings in each game.
                </div>
              </div>
            </div>

            <div class="card bg-base-200 shadow">
              <div class="card-body">
                <div class="text-lg font-bold">Tip</div>
                <div class="text-sm opacity-70">
                  Use the dropdown up top to switch between the main Leaderboard & Tournament Ranks for Each Game.
                </div>
              </div>
            </div>
          </div>

          <!-- CENTER -->
          <div class="lg:col-span-9 space-y-4">

            <!-- LEADERBOARD -->
            <div class="card bg-base-200 shadow">
              <div class="card-body relative">

                <!-- Header row with Refresh button added -->
                <div class="flex items-center justify-between gap-3 flex-wrap">
                  <div class="text-xl font-bold">Leaderboard</div>

                  <div class="flex items-center gap-2 flex-wrap">

  <!-- Search -->
  <div class="relative">
    <input
      id="lbSearch"
      type="text"
      class="input input-bordered input-sm w-64 max-w-[70vw] pr-9"
      placeholder="Search player‚Ä¶"
      autocomplete="off"
    />
    <button
      id="lbSearchClear"
      class="btn btn-ghost btn-xs absolute right-1 top-1/2 -translate-y-1/2 hidden"
      type="button"
      aria-label="Clear search"
    >
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>

  <!-- Refresh -->
  <button id="lbRefreshBtn" class="btn btn-outline btn-sm">
    <span id="lbRefreshSpin" class="loading loading-spinner loading-xs hidden"></span>
    <span id="lbRefreshText">Refresh</span>
  </button>

  <div id="updated" class="text-sm opacity-70"></div>
</div>
                </div>

                <div id="lbLoadingBox" class="mt-3 bg-base-300 rounded-xl px-4 py-4">
                  <div class="flex items-center gap-3">
                    <span class="loading loading-spinner loading-md"></span>
                    <div>
                      <div id="lbLoadingTitle" class="text-lg font-bold">Loading leaderboard‚Ä¶</div>
                      <div class="text-sm opacity-70">Please wait‚Ä¶</div>
                    </div>
                  </div>
                </div>

                <div id="lb" class="mt-3 space-y-2 hidden"></div>

                <div class="mt-4 flex items-center justify-between">
                  <button id="lbPrev" class="btn btn-sm btn-outline" disabled>
                    <i class="fa-solid fa-chevron-left"></i>
                  </button>
                  <div id="lbPageInfo" class="text-sm opacity-70">Page 1 of 1</div>
                  <button id="lbNext" class="btn btn-sm btn-outline" disabled>
                    <i class="fa-solid fa-chevron-right"></i>
                  </button>
                </div>

                <div id="lbOverlay" class="overlayBox hidden">
                  <div class="flex items-center gap-3 bg-base-300 rounded-xl px-4 py-3 shadow">
                    <span class="loading loading-spinner loading-md"></span>
                    <div class="text-lg font-bold" id="lbOverlayText">Loading‚Ä¶</div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- PRIZE POOL -->
      <section id="panel_prizepool" class="hidden space-y-4">
        <div class="card bg-base-200 shadow">
          <div class="card-body text-center space-y-3">
            <div class="text-3xl font-extrabold leading-tight">
              <div>Dah Goose Is Loose #3</div>
              <div class="opacity-80">Current Prize Pool</div>
            </div>

            <div id="prizePoolAmount" class="prizePoolAmount text-5xl sm:text-6xl font-extrabold">
            <span class="loading loading-spinner loading-lg"></span>
            </div>

            <div class="text-sm opacity-70">
              If you would like to Contribute towards the pot send me a DM on Discord
            </div>
          </div>
        </div>
      </section>

      <!-- VOTING / REDEEMS -->
      <section id="panel_voting" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-start">

          <!-- CENTER (Poll) -->
          <div class="lg:col-span-8 space-y-4">

            <!-- POLL -->
            <div class="card bg-base-200 shadow">
              <div class="card-body relative">

                <div id="pollLoadingBox" class="bg-base-300 rounded-xl px-4 py-4">
                  <div class="flex items-center gap-3">
                    <span class="loading loading-spinner loading-md"></span>
                    <div>
                      <div id="pollLoadingTitle" class="text-lg font-bold">Loading poll‚Ä¶</div>
                      <div class="text-sm opacity-70">Please wait‚Ä¶</div>
                    </div>
                  </div>
                </div>

                <div id="pollContent" class="hidden">

                  <div class="flex items-start justify-between gap-3 flex-wrap">
                    <div class="flex items-center gap-2">
                      <div id="pollStateBadge" class="badge badge-outline px-3 py-3 font-bold">CLOSED</div>
                    </div>

                    <div class="flex items-center gap-2">
                      <button id="pollRefreshBtn" class="btn btn-outline btn-sm">
                        <span id="pollRefreshSpin" class="loading loading-spinner loading-xs hidden"></span>
                        <span id="pollRefreshText">Refresh</span>
                      </button>
                    </div>
                  </div>

                  <div class="mt-2">
                    <div id="pollTitle" class="text-2xl font-extrabold"></div>
                    <div id="pollSubtitle" class="text-sm opacity-70 mt-1"></div>
                  </div>

                  <div id="pollMsg" class="text-sm mt-2 opacity-80"></div>

                  <div class="mt-4">
                    <div class="text-sm opacity-70 mb-2">Current Top 3</div>
                    <div id="pollTop" class="flex flex-wrap gap-2"></div>
                  </div>

                  <div class="mt-4">
                    <div class="text-sm opacity-70 mb-2">Totals</div>
                    <div id="pollTotals" class="space-y-2"></div>

                    <div class="mt-4 flex items-center justify-between">
                      <button id="pollPrev" class="btn btn-sm btn-outline" disabled>
                        <i class="fa-solid fa-chevron-left"></i>
                      </button>
                      <div id="pollPageInfo" class="text-sm opacity-70">Page 1 of 1</div>
                      <button id="pollNext" class="btn btn-sm btn-outline" disabled>
                        <i class="fa-solid fa-chevron-right"></i>
                      </button>
                    </div>
                  </div>

                </div><!-- /pollContent -->

                <div id="pollOverlay" class="overlayBox hidden">
                  <div class="flex items-center gap-3 bg-base-300 rounded-xl px-4 py-3 shadow">
                    <span class="loading loading-spinner loading-md"></span>
                    <div class="text-lg font-bold" id="pollOverlayText">Refreshing‚Ä¶</div>
                  </div>
                </div>

              </div>
            </div>

          </div>

<!-- RIGHT (Shop) -->
<div class="lg:col-span-4 lg:sticky lg:top-4 space-y-4">
  <div id="shopCard" class="card bg-base-200 shadow cursor-pointer select-none hover:shadow-lg transition-shadow">
    <div class="card-body space-y-2">
      <div class="text-xl font-bold flex items-center gap-2">
        <i class="fa-solid fa-cart-shopping"></i>
        <span>Loaf Shop</span>
      </div>

      <div class="opacity-70 text-sm">
        Spend your Loaf Points on tournament shenanigans, effects, and more.
      </div>

      <div class="mt-2">
        <button class="btn btn-primary btn-sm w-full">
          Open Shop
        </button>
      </div>
    </div>
  </div>

  <div class="card bg-base-200 shadow">
    <div class="card-body">
      <div class="text-lg font-bold">Tip</div>
      <div class="text-sm opacity-70">
        Some items may only be available when I announce them on stream.
      </div>
    </div>
  </div>
</div>

        </div>
      </section>

<!-- HOW TO LOAF -->
<section id="panel_howtoloaf" class="hidden space-y-4">

  <!-- Intro -->
  <div class="card bg-base-200 shadow">
    <div class="card-body space-y-2">
      <div class="text-3xl font-extrabold">How to Loaf</div>
      <div class="opacity-70">
        So you want to learn how to earn Loafs and what to do with them? Then keep on reading to learn all about em below!
      </div>
    </div>
  </div>

  <!-- ATTENTION -->
<div class="alert alert-warning">
    <div class="flex flex-col space-y-2">
      <div class="text-lg font-extrabold">üö® ATTENTION üö®</div>
      <p>
        Before you can earn or spend Loaf Points, you must log in with Twitch on this site at least once using the Login button at the top.
      </p>
      <ul class="list-disc list-inside">
        <li>‚úÖ Logging in one time links your Twitch account to the site</li>
        <li>‚úÖ After that, you can redeem Loafs on Twitch without logging in again</li>
        <li>üîÅ You only need to log in again if you want to spend Loaf Points on the site</li>
        <li>‚ùå If you never log in at least once, your Loafs cannot be tracked and redeems on Twitch will do nothing</li>
      </ul>
    </div>
  </div>

  <!-- Earning Loafs -->
  <div class="card bg-base-200 shadow">
    <div class="card-body space-y-3">
      <div class="text-2xl font-extrabold flex items-center gap-2">üçû Earning Loafs</div>
      <div class="opacity-70">
        There are currently 2 ways to Earn Loafs at this time:
      </div>
      <ul class="list-disc list-inside space-y-1">
        <li>Redeeming on Twitch (with Channel Points)</li>
        <li>Participating in Dah Goose Is Loose Tournaments</li>
      </ul>
    </div>
  </div>

  <!-- Twitch Redemption -->
  <div class="card bg-base-200 shadow">
    <div class="card-body space-y-3">
      <div class="text-2xl font-extrabold flex items-center gap-2">
        <i class="fa-brands fa-twitch"></i> Twitch Redemption
      </div>
      <div class="opacity-70">
        On my Twitch channel, you can redeem Channel Points to earn Loaf Points every time I stream.
      </div>
      <ul class="list-disc list-inside space-y-1">
        <li>2,500 Channel Points = 100 Loaf Points</li>
        <li>Can be redeemed up to 3√ó per stream (300 Loafs per stream minimum)</li>
      </ul>
    </div>
  </div>

  <!-- DGIL Tournaments -->
  <div class="card bg-base-200 shadow">
    <div class="card-body space-y-3">
      <div class="text-2xl font-extrabold flex items-center gap-2">üèÜ Participate in DGIL Tournaments</div>
      <div class="opacity-70">
        Every time you participate in a DGIL Tournament, you earn Loaf Points based on your placement:
      </div>

      <ul class="list-disc list-inside space-y-1">
        <li>1st Place = 1,000 Loafs</li>
        <li>2nd Place = 900 Loafs</li>
        <li>3rd Place = 800 Loafs</li>
        <li>4th Place = 700 Loafs</li>
        <li>5th Place = 600 Loafs</li>
        <li>7th Place = 500 Loafs</li>
        <li>9th Place = 400 Loafs</li>
        <li>13th Place = 300 Loafs</li>
        <li>17th Place = 200 Loafs</li>
        <li>25th ‚Äì ‚àû Place = 100 Loafs</li>
      </ul>

      <div class="opacity-70">
        No matter what, you will earn at least 100 Loafs for participating.
      </div>

      <div class="alert alert-warning">
        <span>
          Big Exception: If you DQ, you receive 0 Loaf Points to keep things fair and prevent abuse.
        </span>
      </div>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Spending Loafs -->
  <div class="card bg-base-200 shadow">
    <div class="card-body space-y-3">
      <div class="text-2xl font-extrabold flex items-center gap-2">üé≤ What to do with Loaf Points</div>

      <div class="opacity-70">
        (1/11/2026) You can spend Loaf Points on this site in the
        <strong>Voting / Redeems</strong> tab.
      </div>

      <div class="alert alert-error">
        <span>
          üö® These features will not be used for every tournament. I will always announce when they are active.
        </span>
      </div>

      <ul class="list-disc list-inside space-y-2">
        <li>
          <strong>Use Loafs for Polls</strong>
          <span class="opacity-70">
            ‚Äî vote on things like character bans, silly rules, or fun event modifiers.
          </span>
        </li>
        <li>
          <strong>Redeem Silly Tournament Effects</strong>
          <span class="opacity-70">
            ‚Äî randomize seeding, move seeds up/down, shields, shield breaks, and more.
          </span>
        </li>
      </ul>

      <div class="opacity-70">
        (More features will be added over time ‚Äî updates will be announced on stream and reflected here.)
      </div>
    </div>
  </div>

</section>

    </div>
  </div>
<!-- Current Tournament Modal -->
<div id="ctModal" class="fixed inset-0 z-[9998] hidden">
  <!-- backdrop -->
  <div id="ctBackdrop" class="absolute inset-0 bg-black/60"></div>

  <!-- modal card -->
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="card bg-base-200 shadow-xl w-full max-w-xl max-h-[85vh] overflow-auto relative">
      <div class="card-body space-y-3">

        <div class="flex items-start justify-between gap-3">
         <div>
  <!-- Title -->
  <div class="text-2xl font-extrabold flex items-center gap-2">
    <i class="fa-solid fa-trophy"></i>
    <span id="ctTitle">Current Tournament</span>
  </div>

  <!-- Game line (NEW) -->
  <div id="ctGame" class="text-lg font-semibold opacity-80 mt-1"></div>

  <!-- Region line (slightly bigger than before) -->
  <div id="ctRegion" class="text-base opacity-70"></div>
</div>

          <button id="ctClose" class="btn btn-sm btn-ghost">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div id="ctLoading" class="bg-base-300 rounded-xl px-4 py-4">
          <div class="flex items-center gap-3">
            <span class="loading loading-spinner loading-md"></span>
            <div>
              <div class="text-lg font-bold">Loading‚Ä¶</div>
              <div class="text-sm opacity-70">Please wait‚Ä¶</div>
            </div>
          </div>
        </div>

        <div id="ctContent" class="hidden space-y-3">
          <div class="bg-base-300 rounded-xl p-4 space-y-2">
            <div id="ctDateLine" class="text-xl sm:text-2xl font-extrabold"></div>
            <div id="ctPoolsLine" class="text-lg sm:text-xl font-bold opacity-90"></div>
            <div class="text-sm sm:text-base opacity-70">Times shown auto-convert to your timezone.</div>
          </div>

          <div class="bg-base-300 rounded-xl p-4 space-y-2">
            <div class="text-lg sm:text-xl font-extrabold">Registration Closes:</div>
            <div id="ctRegCloseLine" class="text-base sm:text-lg opacity-80"></div>
          </div>

          <div id="ctNotesBox" class="bg-base-300 rounded-xl p-4 space-y-2 hidden">
            <div class="font-bold">Notes</div>
            <div id="ctNotes" class="opacity-80 whitespace-pre-wrap"></div>
          </div>

          <div class="flex flex-wrap gap-2">
            <a id="ctSignupBtn" class="btn btn-success" href="#" target="_blank" rel="noopener">
              <i class="fa-solid fa-arrow-up-right-from-square"></i>
              Register Now
            </a>

            <button id="ctPrizeBtn" class="btn btn-outline">
              <i class="fa-solid fa-sack-dollar"></i>
              View Prize Pool
            </button>
          </div>
        </div>

        <div id="ctEmpty" class="hidden bg-base-300 rounded-xl p-4">
          <div class="font-bold">No active tournament right now.</div>
          <div class="text-sm opacity-70 mt-1">Check back soon ‚Äî I‚Äôll update this when the next DGIL is announced.</div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Shop Modal -->
<div id="shopModal" class="fixed inset-0 z-[9998] hidden">
  <!-- backdrop -->
  <div id="shopBackdrop" class="absolute inset-0 bg-black/60"></div>

  <!-- modal -->
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="card bg-base-200 shadow-xl w-full max-w-5xl max-h-[88vh] overflow-hidden relative">
      <!-- HEADER -->
      <div class="px-6 pt-5 pb-4 border-b border-white/5 flex items-start justify-between gap-3">
        <div>
          <div class="text-2xl font-extrabold flex items-center gap-2">
            <i class="fa-solid fa-cart-shopping"></i>
            <span>Loaf Shop</span>
          </div>
          <div class="opacity-70 text-sm mt-1">
            Redeem Loafs for stuff I enable per tournament.
          </div>
        </div>

        <!-- RIGHT SIDE (RED): balance + close -->
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 bg-base-300 rounded-xl px-4 py-3">
            <span class="text-lg">üçû</span>
          <div class="text-base font-extrabold leading-tight">
          <span class="opacity-80">Loaf Balance:</span>
          <span class="inline-flex items-center gap-2 ml-1">
          <span id="shopBalSpin" class="loading loading-spinner loading-sm hidden"></span>
          <span id="shopBalance" class="pixelNum text-lg"></span>
          </span>
          </div>
          </div>

          <button id="shopClose" class="btn btn-sm btn-ghost border border-white/10 rounded-xl">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>

      <!-- BODY -->
      <div class="p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- LEFT SIDEBAR (BLUE): info + vertical tabs -->
        <div class="lg:col-span-3 space-y-4">
          <div class="text-xs opacity-70 leading-snug">
            (Some Redeems will be enabled only when announced for a tournament. You must logged in to use your Loaf Balance)
          </div>

          <div class="flex flex-col gap-2">
            <button id="shopTab_items" class="btn btn-sm shopTabBtn">Items</button>
            <button id="shopTab_tourney" class="btn btn-sm shopTabBtn">Tournament</button>
            <button id="shopTab_cosmetic" class="btn btn-sm shopTabBtn">Cosmetic</button>
          </div>
        </div>

     <!-- MAIN CONTENT (GREEN): scroll list area -->
<div class="lg:col-span-9">
  <div id="shopRedeemsPane" class="bg-base-300 rounded-2xl p-4 relative overflow-hidden">

    <!-- FX BEHIND CONTENT -->
    <div id="shopRedeemsFx" aria-hidden="true"></div>

    <!-- CONTENT ABOVE FX -->
    <div id="shopRedeemsContent" class="relative z-10">
      <div id="shopPanel_items" class="">
        <div id="shopList_items" class="shopList"></div>
      </div>

      <div id="shopPanel_tourney" class="hidden">
        <div id="shopList_tourney" class="shopList"></div>
      </div>

      <div id="shopPanel_cosmetic" class="hidden">
        <div id="shopList_cosmetic" class="shopList"></div>
      </div>
    </div>

  </div>
</div>
    </div>
  </div>
</div>
  
<script>
/** ====== CONFIG ====== **/
const API_BASE = "https://script.google.com/macros/s/AKfycbwg_pn2J8399br-rnzHT36BG2JtIgB1nPEfya9PTV9TD__kwidzJUZZqRfb-o7I5baHkA/exec";
const TWITCH_CLIENT_ID = "h450xh8v0w6osff946wcqnb8vr2st4";
const TOURNAMENT_ID = "DGIL_NEXT";

/** Boards shown in dropdown **/
const BOARDS = [
  { id: "general", label: "Leaderboard (General)" },
  { id: "rivals2", label: "Rivals of Aether 2" },
  { id: "rivals1", label: "Rivals of Aether" },
  { id: "nasb2",  label: "Nickelodeon All-Star Brawl 2" }
];

let currentBoard = localStorage.getItem("loaf_board") || "general";
if (!BOARDS.some(b => b.id === currentBoard)) {
  currentBoard = "general";
  localStorage.setItem("loaf_board", "general");
}

const PAGE_SIZE = 12;
let lbPage = 1;
let lastLeaderboardData = [];
let lastLeaderboardHash = "";

/** Leaderboard refresh state **/
let lbBusy = false;

/** SEARCH GLOBALS RIGHT HERE **/
let lbQuery = "";          
let lbQueryDebounce = null;
let meDisplayName = "";    

/** Poll state **/
const POLL_PAGE_SIZE = 5;
let pollPage = 1;
let pollCache = null;
let pollExpandedId = null;
let voteBusy = false;
let pollHasLoadedOnce = false;

/** preserves typed amounts so auto-refresh doesn't wipe input */
const pollDraft = {}; // character_id -> string value

/** ====== SAFE HELPERS (prevents script from dying) ====== **/
const $ = (id) => document.getElementById(id);
const on = (id, evt, fn) => { const el = $(id); if (el) el.addEventListener(evt, fn); };
const getToken = () => sessionStorage.getItem("twitch_token");

function safeClassToggle(id, cls, onOff){
  const el = $(id);
  if (!el) return;
  el.classList.toggle(cls, onOff);
}

function safeText(id, txt){
  const el = $(id);
  if (!el) return;
  el.textContent = txt;
}

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, (m) => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
  }[m]));
}

function setStatus(msg) { safeText("status", msg || ""); }

  function setShopBalanceLoading(isLoading){
  const spin = $("shopBalSpin");
  if (spin) spin.classList.toggle("hidden", !isLoading);
}

function updateAuthButtonUI() {
  const btnText = $("authBtnText");
  const btn = $("authBtn");
  if (!btnText || !btn) return;

  const hasToken = !!getToken();
  btnText.textContent = hasToken ? "Logout" : "Login";
  btn.classList.toggle("btn-error", hasToken);
  btn.classList.toggle("btn-primary", !hasToken);
}

/** KEEP your leaderboard icons exactly as you had them **/
function topIcon(rank) {
  if (rank === 1) return '<i class="fa-solid fa-crown text-yellow-400"></i>';
  if (rank === 2) return '<i class="fa-solid fa-medal text-gray-300"></i>';
  if (rank === 3) return '<i class="fa-solid fa-medal text-orange-400"></i>';
  return '<i class="fa-solid fa-user opacity-60"></i>';
}
  
  function avatarHtml_(url, name) {
  const safeName = escapeHtml(name || "");
  const safeUrl = (url && String(url).trim() !== "") ? String(url).trim() : "";
  if (!safeUrl) {
    return `
      <div class="lbAvatar bg-base-300">
        <i class="fa-solid fa-user"></i>
      </div>
    `;
  }
  return `
    <div class="lbAvatar">
      <img src="${escapeHtml(safeUrl)}" alt="${safeName}" loading="lazy" referrerpolicy="no-referrer" />
    </div>
  `;
}

function apiGet(route, params = {}) {
  const usp = new URLSearchParams();
  usp.set("route", route);

  for (const [k, v] of Object.entries(params)) {
    if (v === undefined || v === null) continue;
    usp.set(k, String(v));
  }

  const url = API_BASE + (API_BASE.includes("?") ? "&" : "?") + usp.toString();

  return fetch(url, { cache: "no-store" })
    .then(async (r) => {
      const t = await r.text();
      try { return JSON.parse(t); }
      catch { return { ok:false, error:"Bad JSON response", raw:t, url }; }
    })
    .catch((err) => ({ ok:false, error:String(err), url }));
}

function apiPost(json){
  return fetch(API_BASE, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(json)
  }).then(async (r) => {
    const t = await r.text();
    try { return JSON.parse(t); } catch { return { ok:false, error:"Bad JSON response", raw:t }; }
  });
}

function uuid(){
  if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
  return String(Date.now()) + "-" + Math.random().toString(16).slice(2);
}

  function openCtModal(){
  safeClassToggle("ctModal", "hidden", false);
  document.body.style.overflow = "hidden";
}

function closeCtModal(){
  safeClassToggle("ctModal", "hidden", true);
  document.body.style.overflow = "";
}

function fmtLocal(dt){
  // dt is a Date
  return new Intl.DateTimeFormat(undefined, {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric"
  }).format(dt);
}

function fmtTimeLocal(dt){
  return new Intl.DateTimeFormat(undefined, {
    hour: "numeric",
    minute: "2-digit"
  }).format(dt);
}

// Combines a "date-only" + "time-only" value into a real Date.
// Works even if your time-only comes through as that 1899 thing.
function combineDateAndTime(dateVal, timeVal){
  const d = new Date(dateVal);
  const t = new Date(timeVal);

  if (!Number.isFinite(d.getTime())) return null;

  let hh = 0, mm = 0;
  if (Number.isFinite(t.getTime())) {
    hh = t.getHours();
    mm = t.getMinutes();
  } else {
    // If timeVal is a string like "5:30 PM"
    const s = String(timeVal || "").trim();
    const m = s.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)?$/i);
    if (m){
      hh = parseInt(m[1],10);
      mm = parseInt(m[2],10);
      const ap = (m[3]||"").toUpperCase();
      if (ap === "PM" && hh < 12) hh += 12;
      if (ap === "AM" && hh === 12) hh = 0;
    }
  }

  d.setHours(hh, mm, 0, 0);
  return d;
}

async function fetchCurrentTournament(){
  // if your route is named differently in Apps Script, this is the only line you change:
  const j = await apiGet("current_tournament", {});
  return j;
}

async function refreshCurrentTournamentUI({silent=false} = {}){
  const btn = $("ctBtn");
  const dot = $("ctDot");

  try {
    const j = await fetchCurrentTournament();

    const active = !!j.active;
    if (btn) btn.classList.toggle("ctActive", active);
    if (dot) dot.classList.toggle("bg-success", active);

    // If we‚Äôre not currently showing the modal, stop here.
    // (We still wanted the glow to update.)
    if (silent) return;

    // Modal loading states
    safeClassToggle("ctLoading", "hidden", false);
    safeClassToggle("ctContent", "hidden", true);
    safeClassToggle("ctEmpty", "hidden", true);

    if (!active){
      safeText("ctTitle", "Current Tournament");
      safeText("ctRegion", "");
      safeClassToggle("ctLoading", "hidden", true);
      safeClassToggle("ctEmpty", "hidden", false);
      return;
    }

    // Fill modal
    safeText("ctTitle", j.tournament_name || "Current Tournament");
    safeText("ctGame", j.game ? `Game: ${j.game}` : "");
    safeText("ctRegion", j.region ? `Region: ${j.region}` : "");

    const startDT = combineDateAndTime(j.start_date, j.start_time);
    const regCloseDT = combineDateAndTime(j.reg_close_date, j.reg_close_time);

    if (startDT){
      safeText("ctDateLine", fmtLocal(startDT));
      safeText("ctPoolsLine", `Pools Start: ${fmtTimeLocal(startDT)}`);
    } else {
      safeText("ctDateLine", "");
      safeText("ctPoolsLine", "");
    }

if (regCloseDT){
  safeText("ctRegCloseLine", `${fmtLocal(regCloseDT)} at ${fmtTimeLocal(regCloseDT)}`);
} else {
  safeText("ctRegCloseLine", "");
}


    const signup = String(j.signup_url || "").trim();
    const signupBtn = $("ctSignupBtn");
    if (signupBtn){
      signupBtn.href = signup || "#";
      signupBtn.classList.toggle("btn-disabled", !signup);
      signupBtn.setAttribute("aria-disabled", (!signup).toString());
    }

    const notes = String(j.notes || "").trim();
    safeText("ctNotes", notes);
    safeClassToggle("ctNotesBox", "hidden", !notes);

    safeClassToggle("ctLoading", "hidden", true);
    safeClassToggle("ctContent", "hidden", false);

  } catch (e) {
    if (!silent){
      safeClassToggle("ctLoading", "hidden", true);
      safeClassToggle("ctContent", "hidden", true);
      safeClassToggle("ctEmpty", "hidden", false);
      safeText("ctTitle", "Current Tournament");
      safeText("ctRegion", "");
    }
  }
}

/** ====== LOAF FX ====== **/
function throwLoafs(){
  const layer = $("fxLayer");
  if (!layer) return;

  const count = 14;
  const x = window.innerWidth * 0.5;
  const y = window.innerHeight * 0.35;

  for (let i=0;i<count;i++){
    const el = document.createElement("div");
    el.className = "crumb";
    el.textContent = "üçû";
    el.style.left = x + "px";
    el.style.top = y + "px";

    const dx = (Math.random()*260 - 130) + "px";
    const dy = (Math.random()*220 - 220) + "px";
    const rot = (Math.random()*240 - 120) + "deg";
    el.style.setProperty("--dx", dx);
    el.style.setProperty("--dy", dy);
    el.style.setProperty("--rot", rot);

    layer.appendChild(el);
    setTimeout(() => el.remove(), 750);
  }
}

  /** ====== SHOP FX (falling loafs behind redeems) ====== **/
let shopFxTimer = null;

function startShopFx(){
  stopShopFx(); // safety

  const fx = $("shopRedeemsFx");
  const pane = $("shopRedeemsPane");
  if (!fx || !pane) return;

  const spawn = () => {
    // if modal is hidden, don't spawn
    const modal = $("shopModal");
    if (!modal || modal.classList.contains("hidden")) return;

    const w = pane.clientWidth || 600;

    const el = document.createElement("div");
    el.className = "shopLoaf";
    el.textContent = "üçû";

    // random x within pane
    const x = Math.random() * w;
    el.style.left = x + "px";

    // slow drift + spin
    const drift = (Math.random() * 120 - 60) + "px";  // -60..60
    const spin  = (Math.random() * 220 - 110) + "deg"; // -110..110
    el.style.setProperty("--drift", drift);
    el.style.setProperty("--spin", spin);

    // slow duration (eye friendly)
    const dur = 9000 + Math.random() * 6000; // 9s..15s
    el.style.animationDuration = dur + "ms";

    // stagger start a bit
    el.style.animationDelay = (Math.random() * 800) + "ms";

    fx.appendChild(el);

    // remove when done (prevents buildup)
    el.addEventListener("animationend", () => el.remove(), { once: true });
  };

  // gentle spawn rate
  shopFxTimer = setInterval(() => spawn(), 950 + Math.random() * 450);

  // spawn a few immediately so it feels alive
  for (let i = 0; i < 3; i++) spawn();
}

function stopShopFx(){
  if (shopFxTimer) {
    clearInterval(shopFxTimer);
    shopFxTimer = null;
  }
  const fx = $("shopRedeemsFx");
  if (fx) fx.innerHTML = "";
}

/** ====== TABS (show/hide panels) ====== **/
const tabs = [
  { tab: "tab_overview", panel: "panel_overview" },
  { tab: "tab_leaderboards", panel: "panel_leaderboards" },
  { tab: "tab_prizepool", panel: "panel_prizepool" },
  { tab: "tab_voting", panel: "panel_voting" },
  { tab: "tab_howtoloaf", panel: "panel_howtoloaf" }
];

function setActiveTab(tabId){
  tabs.forEach(t => {
    const tabEl = $(t.tab);
    const panelEl = $(t.panel);
    if (tabEl) tabEl.classList.toggle("tab-active", t.tab === tabId);
    if (panelEl) panelEl.classList.toggle("hidden", t.tab !== tabId);
  });

  // Board dropdown only visible on Leaderboards tab
  const sel = $("boardSelect");
  if (sel) sel.classList.toggle("hidden", tabId !== "tab_leaderboards");

  // light refresh when opening a tab
  if (tabId === "tab_leaderboards") refreshLeaderboard({quietIfUnchanged:true});
  if (tabId === "tab_voting") refreshPoll({manual:false});
}

function wireTabs(){
  tabs.forEach(t => {
    const tabEl = $(t.tab);
    if (!tabEl) return;
    tabEl.onclick = () => setActiveTab(t.tab);
  });
}

/** ====== LEADERBOARD LOADING UI ====== **/
function showLbFirstLoadBox(show, titleText="Loading leaderboard‚Ä¶"){
  safeText("lbLoadingTitle", titleText);
  safeClassToggle("lbLoadingBox", "hidden", !show);
  safeClassToggle("lb", "hidden", show);
}

function setLbOverlay(show, text="Loading‚Ä¶"){
  safeText("lbOverlayText", text);
  safeClassToggle("lbOverlay", "hidden", !show);
}

/** Leaderboard refresh button UI */
function setLbRefreshBtnLoading(isLoading){
  safeClassToggle("lbRefreshSpin", "hidden", !isLoading);
  safeText("lbRefreshText", isLoading ? "Refreshing‚Ä¶" : "Refresh");
  const btn = $("lbRefreshBtn");
  if (btn) btn.disabled = isLoading;
}

/** ====== LEADERBOARD ====== **/
function renderLeaderboard() {
  const el = $("lb");
  if (!el) return;
  el.innerHTML = "";

  const q = (lbQuery || "").trim().toLowerCase();

  // base list (entire board)
  const base = Array.isArray(lastLeaderboardData) ? lastLeaderboardData : [];

  // filter: CONTAINS (case-insensitive)
  const list = q
    ? base.filter(p => {
        const name = String(p.display_name || p.twitch_login || "").toLowerCase();
        return name.includes(q);
      })
    : base;

  const pages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
  lbPage = Math.min(Math.max(1, lbPage), pages);

  // No results message
  if (list.length === 0) {
    el.innerHTML = `
      <div class="lbNoResults">
        <div class="title">No players found</div>
        <div class="sub">for ‚Äú${escapeHtml(lbQuery)}‚Äù</div>
      </div>
    `;
    safeText("lbPageInfo", `Page 1 of 1`);
    const prev = $("lbPrev");
    const next = $("lbNext");
    if (prev) prev.disabled = true;
    if (next) next.disabled = true;
    return;
  }

  const start = (lbPage - 1) * PAGE_SIZE;
  const slice = list.slice(start, start + PAGE_SIZE);

  slice.forEach((p, i) => {
    // IMPORTANT: rank is based on position in the FULL board (not filtered page)
    // so ranks stay correct like you asked (#2, #57, etc.)
    const globalIndex = q ? base.indexOf(p) : (start + i);
    const rank = globalIndex + 1;

    const name = p.display_name || p.twitch_login || "";
    const pts = (p.points ?? 0);

    // Only highlight "me" on General, by display name match (good enough for now)
    const isMe =
      currentBoard === "general" &&
      !!getToken() &&
      meDisplayName &&
      String(name).toLowerCase() === String(meDisplayName).toLowerCase();

    const meClass = isMe ? "outline outline-2 outline-primary/40" : "";

    el.innerHTML += `
      <div class="lbRow flex items-center justify-between bg-base-300 rounded-xl px-4 py-3 ${meClass} ${
        rank === 1 ? "lbTop1" : rank === 2 ? "lbTop2" : rank === 3 ? "lbTop3rd" : ""
      }">
        <div class="lbLeft min-w-0">
          <div class="lbNameRow">
            ${topIcon(rank)}
            <div class="font-bold">#${rank}</div>
            ${currentBoard === "general" ? avatarHtml_(p.avatar_url, name) : ""}
            <div class="lbName">${escapeHtml(name)}</div>
          </div>

          <div class="lbPoints">
            <div class="badge badge-primary text-lg">${pts}</div>
          </div>
        </div>
      </div>
    `;
  });

  safeText("lbPageInfo", `Page ${lbPage} of ${pages}`);

  const prev = $("lbPrev");
  const next = $("lbNext");
  const disableArrows = pages <= 1;

  if (prev) prev.disabled = disableArrows || lbPage <= 1;
  if (next) next.disabled = disableArrows || lbPage >= pages;
}

async function refreshLeaderboard({showOverlay=false, quietIfUnchanged=true, overlayText="Loading‚Ä¶"} = {}) {
  const firstLoad = (lastLeaderboardHash === "");

 if (firstLoad) {
  showLbFirstLoadBox(true, "Loading leaderboard‚Ä¶");
  // removed setStatus here so the header/tabs don't jump
}

  if (showOverlay && !firstLoad) setLbOverlay(true, overlayText);

  try {
    const j = await apiGet("leaderboard", { board: currentBoard });
    const data = j.data || [];
    const h = JSON.stringify(data);

    if (!quietIfUnchanged || firstLoad || h !== lastLeaderboardHash) {
      lastLeaderboardHash = h;
      lastLeaderboardData = data;
      safeText("updated", j.updated ? `Updated: ${new Date(j.updated).toLocaleTimeString()}` : "");
      renderLeaderboard();
    }

    if (firstLoad) showLbFirstLoadBox(false);
  } finally {
    if (showOverlay && !firstLoad) setLbOverlay(false);
    setStatus("");
  }
}

/** ====== ACCOUNT (ME) ====== **/
function setMeOverlay(show, text="Refreshing‚Ä¶"){
  safeText("meOverlayText", text);
  safeClassToggle("meOverlay", "hidden", !show);
}

async function refreshMe({mode="auto"} = {}) {
  const hasToken = !!getToken();

  if (!hasToken) {
    safeClassToggle("acctLoading", "hidden", true);
    safeClassToggle("meCard", "hidden", true);
    safeClassToggle("loginHint", "hidden", false);
    setMeOverlay(false);
    updateAuthButtonUI();
    return;
  }

  updateAuthButtonUI();

  const meCard = $("meCard");
  const meAlreadyVisible = meCard && !meCard.classList.contains("hidden");

  if (mode === "auto" && meAlreadyVisible) {
    setMeOverlay(true, "Refreshing‚Ä¶");
  } else {
    safeClassToggle("loginHint", "hidden", true);
    safeClassToggle("meCard", "hidden", true);
    safeClassToggle("acctLoading", "hidden", false);
  }

  try {
    const r = await fetch("https://api.twitch.tv/helix/users", {
      headers: {
        "Authorization": "Bearer " + getToken(),
        "Client-Id": TWITCH_CLIENT_ID
      }
    });

    if (!r.ok) {
      sessionStorage.removeItem("twitch_token");
      updateAuthButtonUI();

      safeClassToggle("acctLoading", "hidden", true);
      safeClassToggle("meCard", "hidden", true);
      safeClassToggle("loginHint", "hidden", false);
      setMeOverlay(false);

      setStatus("Session expired. Please login again.");
      return;
    }

    const tj = await r.json();
    const me = tj.data?.[0];
    if (!me) throw new Error("Could not read Twitch user.");

    safeText("meName", me.display_name);
    meDisplayName = String(me.display_name || "");

    const g = await apiGet("me", {
      twitch_user_id: me.id,
      twitch_login: me.login,
      display_name: me.display_name,
      avatar_url: me.profile_image_url || "",
      board: "general"
    });

    safeText("meTotalPoints", (g.points ?? 0));
    safeText("meRank", g.rank ? ("#" + g.rank) : "‚Äî");

    safeClassToggle("acctLoading", "hidden", true);
    safeClassToggle("loginHint", "hidden", true);
    safeClassToggle("meCard", "hidden", false);

  } catch (err) {
    if (!(mode === "auto" && meAlreadyVisible)) {
      safeClassToggle("acctLoading", "hidden", true);
      safeClassToggle("meCard", "hidden", true);
      safeClassToggle("loginHint", "hidden", false);
      setStatus("Could not load account info. Try logging out and back in.");
    }
  } finally {
    setMeOverlay(false);
  }
}

/** ===== Poll UI (same logic as before, kept) ===== **/
function setPollMsg(msg, isErr=false){
  const el = $("pollMsg");
  if (!el) return;
  el.textContent = msg || "";
  el.classList.toggle("text-error", !!isErr);
  el.classList.toggle("font-bold", !!msg);
}

function setOpenClosedBadge(isOpen){
  const b = $("pollStateBadge");
  if (!b) return;
  if (isOpen){
    b.textContent = "OPEN";
    b.className = "badge badge-outline px-3 py-3 font-bold border-success text-success";
  } else {
    b.textContent = "CLOSED";
    b.className = "badge badge-outline px-3 py-3 font-bold border-error text-error";
  }
}

function renderTopBadges(names){
  const wrap = $("pollTop");
  if (!wrap) return;
  wrap.innerHTML = "";
  if (!names || !names.length){
    wrap.innerHTML = `<span class="opacity-70">‚Äî</span>`;
    return;
  }
  names.forEach((n, i) => {
    const badge = document.createElement("div");
    badge.className = "badge badge-error badge-lg gap-2";
    badge.textContent = `#${i+1} ${n}`;
    wrap.appendChild(badge);
  });
}

function getSortedOptions(options){
  const arr = (options || []).map((o, i) => ({...o, _idx:i}));
  const maxPts = Math.max(0, ...arr.map(x => Number(x.points||0)));
  if (maxPts === 0) return arr.sort((a,b)=> a._idx - b._idx);
  return arr.sort((a,b)=>{
    const dp = Number(b.points||0) - Number(a.points||0);
    if (dp !== 0) return dp;
    return a._idx - b._idx;
  });
}

function renderPollTotals(){
  const wrap = $("pollTotals");
  if (!wrap) return;
  wrap.innerHTML = "";

  const options = getSortedOptions(pollCache?.options || []);
  if (!options.length){
    wrap.innerHTML = `<div class="opacity-70 text-sm">No options found.</div>`;
    safeText("pollPageInfo", "Page 1 of 1");
    const p = $("pollPrev"), n = $("pollNext");
    if (p) p.disabled = true;
    if (n) n.disabled = true;
    return;
  }

  const pages = Math.max(1, Math.ceil(options.length / POLL_PAGE_SIZE));
  pollPage = Math.min(Math.max(1, pollPage), pages);

  const start = (pollPage - 1) * POLL_PAGE_SIZE;
  const slice = options.slice(start, start + POLL_PAGE_SIZE);

  safeText("pollPageInfo", `Page ${pollPage} of ${pages}`);
  const prev = $("pollPrev"), next = $("pollNext");
  if (prev) prev.disabled = pollPage <= 1;
  if (next) next.disabled = pollPage >= pages;

  const maxPts = Math.max(1, ...options.map(o => Number(o.points||0)));

  slice.forEach(o => {
    const pts = Number(o.points || 0);
    const pct = Math.round((pts / maxPts) * 100);
    const expanded = (pollExpandedId === o.character_id);
    const draftVal = pollDraft[o.character_id] ?? "";

    wrap.innerHTML += `
      <div class="charRow bg-base-300 rounded-xl px-3 py-3">
        <button class="w-full text-left flex items-center justify-between gap-3"
                onclick="togglePollRow('${escapeHtml(o.character_id)}')">
          <div class="flex items-center gap-3 min-w-0">
            <img src="${escapeHtml(o.icon_path || "")}"
                 onerror="this.style.display='none'"
                 class="w-10 h-10 rounded-xl object-cover bg-base-200" alt="">
            <div class="min-w-0">
              <div class="font-bold truncate">${escapeHtml(o.character_name)}</div>
              <div class="w-56 max-w-[50vw] bg-base-200 rounded-full h-2 mt-2 overflow-hidden">
                <div class="h-2 bg-primary" style="width:${pct}%;"></div>
              </div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <div class="badge badge-secondary text-lg">${pts}</div>
            <i class="fa-solid ${expanded ? "fa-chevron-up" : "fa-chevron-down"} opacity-70"></i>
          </div>
        </button>

        ${expanded ? `
          <div class="mt-3 flex items-center gap-2 flex-wrap">
            <input id="voteAmt_${escapeHtml(o.character_id)}"
                   type="number" min="1" step="1"
                   class="input input-bordered w-32"
                   placeholder="Amount"
                   value="${escapeHtml(draftVal)}"
                   oninput="setDraft('${escapeHtml(o.character_id)}', this.value)">
            <button id="voteBtn_${escapeHtml(o.character_id)}"
                    class="btn btn-sm btn-primary"
                    onclick="submitVote('${escapeHtml(o.character_id)}')">
              <span id="voteSpin_${escapeHtml(o.character_id)}" class="loading loading-spinner loading-xs hidden"></span>
              <span id="voteText_${escapeHtml(o.character_id)}">Submit</span>
            </button>
            <div class="text-sm opacity-70">Spend Loaf Points to vote.</div>
          </div>
        ` : ``}
      </div>
    `;
  });
}

window.setDraft = function(character_id, val){
  pollDraft[character_id] = String(val ?? "");
};

window.togglePollRow = function(character_id){
  if (pollExpandedId && pollExpandedId !== character_id) delete pollDraft[pollExpandedId];
  pollExpandedId = (pollExpandedId === character_id) ? null : character_id;
  renderPollTotals();
};

function setPollLoading(firstLoad, text="Loading poll‚Ä¶"){
  if (firstLoad) {
    safeText("pollLoadingTitle", text);
    safeClassToggle("pollLoadingBox", "hidden", false);
    safeClassToggle("pollContent", "hidden", true);
  } else {
    safeClassToggle("pollLoadingBox", "hidden", true);
    safeClassToggle("pollContent", "hidden", false);
  }
}

function setPollOverlay(show, text="Refreshing‚Ä¶"){
  safeText("pollOverlayText", text);
  safeClassToggle("pollOverlay", "hidden", !show);
}

function setPollRefreshBtnLoading(isLoading){
  safeClassToggle("pollRefreshSpin", "hidden", !isLoading);
  safeText("pollRefreshText", isLoading ? "Refreshing‚Ä¶" : "Refresh");
  const btn = $("pollRefreshBtn");
  if (btn) btn.disabled = isLoading || voteBusy;
}

window.submitVote = async function(character_id){
  if (voteBusy) return;

  if (!getToken()){
    setPollMsg("Login with Twitch first.", true);
    return;
  }
  if (pollCache && pollCache.is_open === false){
    setPollMsg("Poll is closed.", true);
    return;
  }

  const input = document.getElementById(`voteAmt_${character_id}`);
  const amt = parseInt(input?.value || "", 10);
  if (!Number.isFinite(amt) || amt <= 0){
    setPollMsg("Enter an amount (example: 25).", true);
    return;
  }

  voteBusy = true;
  setPollRefreshBtnLoading(true);
  setPollMsg("Submitting your vote‚Ä¶", false);

  const btn = document.getElementById(`voteBtn_${character_id}`);
  const spin = document.getElementById(`voteSpin_${character_id}`);
  const text = document.getElementById(`voteText_${character_id}`);
  if (btn) btn.disabled = true;
  if (spin) spin.classList.remove("hidden");
  if (text) text.textContent = "Submitting‚Ä¶";

  try {
    const res = await apiPost({
      route: "vote",
      tournament_id: TOURNAMENT_ID,
      character_id,
      amount: amt,
      token: getToken(),
      spend_id: uuid()
    });

    if (!res.ok){
      if (res.current_points !== undefined){
        setPollMsg(`Not enough Loaf Points. You have ${res.current_points}.`, true);
      } else if (res.error === "poll_closed") {
        setPollMsg("Poll is closed.", true);
      } else {
        setPollMsg(res.error || "Vote failed.", true);
      }
      return;
    }

    if (res.deduped){
      setPollMsg("Already processed (safe double-click protection).");
    } else {
      setPollMsg("Vote counted! üçû");
      throwLoafs();
    }

    if (res.poll && res.poll.ok){
      pollCache = res.poll;
      setOpenClosedBadge(!!pollCache.is_open);
      safeText("pollTitle", pollCache.title || "");
      safeText("pollSubtitle", pollCache.subtitle || "");
      renderTopBadges(pollCache.top || []);
    } else {
      await refreshPoll({manual:false});
    }

    pollPage = 1;
    pollExpandedId = null;
    delete pollDraft[character_id];
    renderPollTotals();

    await refreshMe();

  } finally {
    if (btn) btn.disabled = false;
    if (spin) spin.classList.add("hidden");
    if (text) text.textContent = "Submit";

    voteBusy = false;
    setPollRefreshBtnLoading(false);
  }
};

async function refreshPoll({manual=false} = {}){
  if (!pollHasLoadedOnce) setPollLoading(true, "Loading poll‚Ä¶");

  if (manual) {
    setPollOverlay(true, "Refreshing‚Ä¶");
    setPollRefreshBtnLoading(true);
  }

  try {
    const j = await apiGet("poll", { tournament_id: TOURNAMENT_ID });
    if (!j.ok){
      if (pollHasLoadedOnce) setPollMsg(j.error || "Could not load poll.", true);
      return;
    }

    pollCache = j;

    if (!pollHasLoadedOnce) {
      pollHasLoadedOnce = true;
      setPollLoading(false);
    }

    setOpenClosedBadge(!!j.is_open);
    safeText("pollTitle", j.title || "");
    safeText("pollSubtitle", j.subtitle || "");
    renderTopBadges(j.top || []);
    renderPollTotals();

    if (!voteBusy) setPollMsg("");
  } finally {
    if (manual) {
      setPollOverlay(false);
      setPollRefreshBtnLoading(false);
    }
  }
}

/** ====== SHOP (UI only for now) ====== **/
const SHOP_ITEMS = {
  items: [
    { id:"coming_soon_1", name:"Coming soon", desc:"Shop items will appear here once enabled.", price: 0, disabled:true }
  ],
  tourney: [
    { id:"coming_soon_2", name:"Coming soon", desc:"Tournament stuff will appear here.", price: 0, disabled:true }
  ],
  cosmetic: [
    { id:"coming_soon_3", name:"Coming soon", desc:"Cosmetic stuff will appear here.", price: 0, disabled:true }
  ]
};

async function renderShop(){
  // balance
  const balEl = $("shopBalance");
  if (balEl) balEl.textContent = "";

  // logged out
  if (!getToken()){
    setShopBalanceLoading(false);
    if (balEl) balEl.textContent = "(Login to use)";
  } else {
    // show spinner while fetching
    setShopBalanceLoading(true);
    if (balEl) balEl.textContent = "";

    try {
      const r = await fetch("https://api.twitch.tv/helix/users", {
        headers: { "Authorization": "Bearer " + getToken(), "Client-Id": TWITCH_CLIENT_ID }
      });

      if (!r.ok) throw new Error("twitch_auth_failed");

      const tj = await r.json();
      const me = tj.data?.[0];
      if (!me) throw new Error("no_me");

      const g = await apiGet("me", {
        twitch_user_id: me.id,
        twitch_login: me.login,
        display_name: me.display_name,
        avatar_url: me.profile_image_url || "",
        board: "general"
      });

      if (balEl) balEl.textContent = String(g.points ?? 0);
    } catch (e) {
      if (balEl) balEl.textContent = "(Login to use)";
    } finally {
      setShopBalanceLoading(false);
    }
  }

  // panels
  const pItems = $("shopPanel_items");
  const pTourney = $("shopPanel_tourney");
  const pCos = $("shopPanel_cosmetic");
  const pInfo = $("shopPanel_info");

  if (pItems) pItems.innerHTML = buildShopListHtml(SHOP_ITEMS.items);
  if (pTourney) pTourney.innerHTML = buildShopListHtml(SHOP_ITEMS.tourney);
  if (pCos) pCos.innerHTML = buildShopListHtml(SHOP_ITEMS.cosmetic);

  if (pInfo) {
    pInfo.innerHTML = `
      <div class="card bg-base-300 rounded-xl">
        <div class="card-body">
          <div class="text-lg font-bold">How the Shop works</div>
          <div class="opacity-70 text-sm mt-1">
            Items will be enabled only when announced for a tournament.
            Some purchases may require you to be logged in.
          </div>
        </div>
      </div>
    `;
  }
}

function buildShopListHtml(items){
  const list = Array.isArray(items) ? items : [];
  if (!list.length){
    return `<div class="opacity-70 text-sm">No items right now.</div>`;
  }

  return `
    <div class="shopGrid">
      ${list.map(it => `
        <div class="shopItem">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-lg font-extrabold">${escapeHtml(it.name)}</div>
              <div class="opacity-70 text-sm mt-1">${escapeHtml(it.desc || "")}</div>
            </div>
            <div class="shopPrice flex items-center gap-1">
              <span>üçû</span>
              <span>${Number(it.price || 0)}</span>
            </div>
          </div>

          <div class="mt-3">
            <button class="btn btn-sm btn-primary w-full ${it.disabled ? "btn-disabled" : ""}">
              ${it.disabled ? "Not available yet" : "Redeem"}
            </button>
          </div>
        </div>
      `).join("")}
    </div>
  `;
}
  
/** ====== BOARDS DROPDOWN ====== **/
function buildBoards() {
  const sel = $("boardSelect");
  if (!sel) return;
  sel.innerHTML = "";
  BOARDS.forEach(b => {
    const o = document.createElement("option");
    o.value = b.id;
    o.textContent = b.label;
    if (b.id === currentBoard) o.selected = true;
    sel.appendChild(o);
  });

  sel.onchange = async () => {
    currentBoard = sel.value;
    localStorage.setItem("loaf_board", currentBoard);
    lbPage = 1;
    await refreshLeaderboard({showOverlay:true, quietIfUnchanged:false, overlayText:"Loading‚Ä¶"});
  };
}

/** ====== AUTH BUTTON ====== **/
function wireAuth(){
  const btn = $("authBtn");
  if (!btn) return;

  btn.onclick = () => {
    if (getToken()) {
      sessionStorage.removeItem("twitch_token");
      updateAuthButtonUI();
      setStatus("Logged out.");
      refreshMe();
      refreshLeaderboard({quietIfUnchanged:false});
      return;
    }

    // safer crypto usage
    const state = (window.crypto && crypto.getRandomValues)
      ? crypto.getRandomValues(new Uint32Array(4)).join("-")
      : String(Date.now());

    sessionStorage.setItem("oauth_state", state);

    const redirect = location.origin + location.pathname.replace(/\/[^\/]*$/, "/callback.html");
    const u = new URL("https://id.twitch.tv/oauth2/authorize");
    u.searchParams.set("client_id", TWITCH_CLIENT_ID);
    u.searchParams.set("redirect_uri", redirect);
    u.searchParams.set("response_type", "token");
    u.searchParams.set("state", state);
    location.href = u.toString();
  };
}

/** ====== Pagination + refresh buttons ====== **/
function wireButtons(){
  on("lbPrev", "click", () => { lbPage--; renderLeaderboard(); });
  on("lbNext", "click", () => { lbPage++; renderLeaderboard(); });

  on("pollPrev", "click", () => { pollPage--; renderPollTotals(); });
  on("pollNext", "click", () => { pollPage++; renderPollTotals(); });

  on("pollRefreshBtn", "click", () => {
    if (voteBusy) return;
    refreshPoll({ manual:true });
  });

    // Leaderboard search
  on("lbSearch", "input", (e) => {
    const val = e.target.value || "";
    lbQuery = val;

    // show/hide clear X
    const c = $("lbSearchClear");
    if (c) c.classList.toggle("hidden", !lbQuery.trim());

    // debounce so it doesn't spam renders while typing
    if (lbQueryDebounce) clearTimeout(lbQueryDebounce);
    lbQueryDebounce = setTimeout(() => {
      lbPage = 1;      // typing resets to page 1
      renderLeaderboard();
    }, 120);
  });

  on("lbSearchClear", "click", () => {
    const input = $("lbSearch");
    if (input) input.value = "";
    lbQuery = "";
    const c = $("lbSearchClear");
    if (c) c.classList.add("hidden");
    lbPage = 1;
    renderLeaderboard();
  });

  // Current Tournament modal open/close
  on("ctBtn", "click", async () => {
    openCtModal();
    await refreshCurrentTournamentUI({silent:false});
  });

  on("ctClose", "click", () => closeCtModal());
  on("ctBackdrop", "click", () => closeCtModal());

  on("ctPrizeBtn", "click", () => {
    closeCtModal();
    setActiveTab("tab_prizepool");
  });

// Leaderboard refresh button (refresh leaderboard + account at the same time)
on("lbRefreshBtn", "click", async () => {
  if (lbBusy) return;
  lbBusy = true;

  /* üîΩ E SECTION GOES RIGHT HERE üîΩ */
  // Manual refresh clears search
  const input = $("lbSearch");
  if (input) input.value = "";
  lbQuery = "";
  const c = $("lbSearchClear");
  if (c) c.classList.add("hidden");
  lbPage = 1;

  /* üîº END OF E SECTION üîº */

  setLbRefreshBtnLoading(true);
  setLbOverlay(true, "Refreshing‚Ä¶");

  try {
    await Promise.all([
      refreshLeaderboard({ showOverlay:false, quietIfUnchanged:false }),
      refreshMe({ mode: "auto" })
    ]);
  } finally {
    setLbOverlay(false);
    setLbRefreshBtnLoading(false);
    lbBusy = false;
  }
});

  // ===== Shop modal open/close =====
const openShop = async () => {
  safeClassToggle("shopModal", "hidden", false);
  document.body.style.overflow = "hidden";

  setShopTab("shopTab_items");
  await renderShop();  // ensure panels exist / are rendered
  startShopFx();       // üçû start the background loop
};

const closeShop = () => {
  safeClassToggle("shopModal", "hidden", true);
  document.body.style.overflow = "";

  stopShopFx();        // üçû stop + clear loaf elements
};

  on("shopClose", "click", closeShop);
  on("shopBackdrop", "click", closeShop);
  on("shopCard", "click", openShop);

  // ===== Shop tabs (vertical) =====
  const shopTabs = [
    { tab: "shopTab_items", panel: "shopPanel_items" },
    { tab: "shopTab_tourney", panel: "shopPanel_tourney" },
    { tab: "shopTab_cosmetic", panel: "shopPanel_cosmetic" }
  ];

function setShopTab(tabId){
  shopTabs.forEach(t => {
    const tabEl = $(t.tab);
    const panelEl = $(t.panel);
    const active = (t.tab === tabId);

    if (panelEl) panelEl.classList.toggle("hidden", !active);

    // button styling (use YOUR CSS class)
    if (tabEl){
      tabEl.classList.toggle("shopTabActive", active);
    }
  });
}

  shopTabs.forEach(t => {
    const el = $(t.tab);
    if (el) el.onclick = () => setShopTab(t.tab);
  });
}
/** ====== Init (wrapped so mobile won't race/half-load) ====== **/
document.addEventListener("DOMContentLoaded", async () => {
  updateAuthButtonUI();
  buildBoards();
  wireTabs();
  wireAuth();
  wireButtons();

  // default tab
  setActiveTab("tab_overview");

  // first loads
  showLbFirstLoadBox(true, "Loading leaderboard‚Ä¶");
  await refreshLeaderboard({quietIfUnchanged:false});
  await refreshMe();
  await refreshPoll({manual:false});
  refreshPrizePool();

  // auto refresh (quiet)
  setInterval(() => refreshLeaderboard({quietIfUnchanged:true}), 25000);
  setInterval(() => refreshMe({ mode: "auto" }), 30000);
  setInterval(() => refreshPoll({manual:false}), 30000);
  setInterval(() => refreshPrizePool(), 30000);

  // Current Tournament button glow updater
  await refreshCurrentTournamentUI({silent:true});
  setInterval(() => refreshCurrentTournamentUI({silent:true}), 30000);
});

async function refreshPrizePool(){
  const el = $("prizePoolAmount");
  if (!el) return;

  // Big centered loader immediately
el.innerHTML = `<span class="loading loading-spinner loading-lg"></span>`;

  // Force the browser to paint the spinner NOW (before fetch work)
  await new Promise(requestAnimationFrame);

  try {
    const j = await apiGet("prize_pool", {});
    if (!j || !j.ok) throw new Error(j?.error || "No ok response");

    const amt = Number(j.amount ?? 0);
    if (!Number.isFinite(amt)) throw new Error("Bad amount");

    // wait for the pixel font BEFORE showing the number
    await document.fonts.load('16px "Press Start 2P"');

    el.textContent = "$" + Math.round(amt).toString();
  } catch (e) {
    el.textContent = "‚Äî";
    console.log("Prize pool fetch failed:", e);
  }
}
</script>
</body>
</html>
